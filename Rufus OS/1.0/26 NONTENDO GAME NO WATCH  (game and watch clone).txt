#include <Arduino.h>
#include <U8g2lib.h>
#include <Wire.h>

// SH1106 128x64 I2C
U8G2_SH1106_128X64_NONAME_1_HW_I2C u8g2(U8G2_R0, /* reset=*/ U8X8_PIN_NONE);

// --- PIN DEFINITIONS ---
#define STICK_X    A0
#define STICK_Y    A1
#define BTN_A      11 
#define BTN_MENU   5  
#define BZ_OUT     3  

// --- ENUMS & GLOBAL STATE ---
enum AppState { MENU, OCTOPUS, CHEF, PARACHUTE, VERMIN, MANHOLE, HELMET, GAMEOVER };
AppState currentState = MENU;
int menuSelection = 0;
unsigned long globalTimer = 0;
int score = 0;
int lives = 3;

// Input Variables
float pX = 64.0f, pY = 32.0f; 
float vx = 0, vy = 0; 
int rawX, rawY;

// --- HARDWARE-SAFE DRAWING ---
void safeLine(int x1, int y1, int x2, int y2) {
  x1 = constrain(x1, 0, 127); x2 = constrain(x2, 0, 127);
  y1 = constrain(y1, 0, 63);  y2 = constrain(y2, 0, 63);
  u8g2.drawLine(x1, y1, x2, y2);
}
void safeFrame(int x, int y, int w, int h) {
  if (x > 127 || y > 63 || x + w < 0 || y + h < 0) return;
  u8g2.drawFrame(constrain(x, 0, 127), constrain(y, 0, 63), min(w, 127), min(h, 63));
}
void safeDisc(int x, int y, int r) {
  if (x < -r || x > 127+r || y < -r || y > 63+r) return;
  u8g2.drawDisc(constrain(x, 0, 127), constrain(y, 0, 63), r);
}
void playSfx(int f, int d) { tone(BZ_OUT, f, d); }

// ==========================================================
// GAME 1: OCTOPUS
// ==========================================================
int octo_ext[4]; 
bool hasBag = false;

void octo_reset() { score = 0; lives = 3; pX = 10; pY = 15; hasBag = false; }
void octo_update() {
  pX = constrain(pX + vx * 4.0f, 5, 120);
  pY = constrain(pY + vy * 4.0f, 5, 55);
  for(int i=0; i<4; i++) { octo_ext[i] = (sin((millis() / 400.0) + i) * 2.0) + 2.0; }
  for(int i=0; i<4; i++) {
    int ax = 35 + (i * 20);
    int ay_tip = 20 + (octo_ext[i] * 10);
    if (abs(pX - ax) < 8 && pY > 15 && pY < ay_tip + 5) {
      lives--; pX = 10; pY = 15; hasBag = false; playSfx(100, 400); 
      if (lives <= 0) currentState = GAMEOVER; 
    }
  }
  if (pX > 105 && pY > 45) { if (!hasBag) { score += 1; hasBag = true; playSfx(1200, 20); } }
  if (hasBag && pX < 15 && pY < 20) { score += 10; hasBag = false; playSfx(1800, 50); }
}
void octo_draw() {
  u8g2.drawBox(0, 10, 15, 8); u8g2.drawFrame(110, 52, 12, 8); safeDisc(90, 25, 8);
  for(int i=0; i<4; i++) { int ax = 35 + (i * 20); for(int s=0; s <= octo_ext[i]; s++) safeDisc(ax, 20 + (s * 10), 2); }
  safeDisc((int)pX, (int)pY, 3);
  if(hasBag) u8g2.drawPixel(pX+2, pY+2);
}

// ==========================================================
// GAME 2: CHEF
// ==========================================================
struct Food { float x, y, vx, vy; bool active; };
Food food[3];
void chef_reset() { score = 0; lives = 3; pX = 64; for(int i=0; i<3; i++) food[i].active = false; food[0] = {20, 0, 0.5, 0, true}; }
void chef_update() {
  pX = constrain(pX + vx * 5.5f, 15, 113);
  if (millis() % 4000 < 20) { 
    for(int i=0; i<3; i++) if(!food[i].active) { food[i] = {(float)random(20, 100), -5, (random(0,2)?0.4f:-0.4f), 0, true}; break; } 
  }
  for(int i=0; i<3; i++) {
    if (!food[i].active) continue;
    food[i].x += food[i].vx; food[i].y += food[i].vy; food[i].vy += 0.08;
    if (food[i].x < 10 || food[i].x > 118) food[i].vx *= -1;
    if (food[i].y > 52 && food[i].vy > 0) {
      if (abs(food[i].x - pX) < 14) { food[i].vy = -3.4; score++; playSfx(1000, 20); }
      else if (food[i].y > 64) { food[i].active = false; lives--; playSfx(80, 500); if (lives <= 0) currentState = GAMEOVER; else food[i]={64,-5,0.4,0,true}; }
    }
  }
}
void chef_draw() {
  for(int i=0; i<3; i++) if(food[i].active) { u8g2.drawPixel(food[i].x, 0); safeDisc(food[i].x, food[i].y, 2); }
  safeLine(pX-12, 57, pX+12, 57); safeDisc(pX, 48, 4);
}

// ==========================================================
// GAME 4: VERMIN (Mole Whack - SNAP CONTROLS)
// ==========================================================
int active_mole_x = -1;
unsigned long mole_active_timer = 0;

void vermin_reset() {
  score = 0; lives = 3; 
  active_mole_x = -1;
  globalTimer = millis() + 1000;
}

void vermin_update() {
  pX = map(rawX, 0, 1023, 15, 113); // Absolute Snap
  
  // Spawning Logic
  if (active_mole_x == -1) {
    if (millis() > globalTimer) {
      active_mole_x = 15 + random(0, 5) * 24;
      mole_active_timer = millis() + (1000 - min(600, score * 2));
      playSfx(400, 20);
    }
  } else {
    // Check for Hit
    if (abs(pX - active_mole_x) < 12) {
      score += 5;
      active_mole_x = -1;
      playSfx(1600, 20);
      globalTimer = millis() + random(500, 1500);
    } 
    // Check for Escape
    else if (millis() > mole_active_timer) {
      active_mole_x = -1;
      lives--;
      playSfx(100, 400);
      if (lives <= 0) currentState = GAMEOVER;
      globalTimer = millis() + 1000;
    }
  }
}

void vermin_draw() {
  for(int i=0; i<5; i++) {
    int x = 15 + i*24;
    u8g2.drawCircle(x, 52, 5); 
    if (active_mole_x == x) safeDisc(x, 50, 4); 
  }
  // Hammer
  safeLine(pX-6, 38, pX+6, 38); 
  safeLine(pX, 38, pX, 48);
}

// ==========================================================
// GAME 5: MANHOLE (Quadrant Save - SNAP CONTROLS)
// ==========================================================
int active_hole_idx = -1;
unsigned long hole_active_timer = 0;

void manhole_reset() {
  score = 0; lives = 3;
  active_hole_idx = -1;
  globalTimer = millis() + 1000;
}

void manhole_update() {
  pX = map(rawX, 0, 1023, 20, 108); // Absolute Snap
  pY = map(rawY, 0, 1023, 15, 55);
  
  if (active_hole_idx == -1) {
    if (millis() > globalTimer) {
      active_hole_idx = random(0, 4);
      hole_active_timer = millis() + 1200 - min(600, score);
      playSfx(300, 30);
    }
  } else {
    int tx = (active_hole_idx % 2 == 0) ? 25 : 103;
    int ty = (active_hole_idx < 2) ? 20 : 50;
    
    // Check if player is in the correct quadrant
    if (abs(pX - tx) < 20 && abs(pY - ty) < 20) {
      score += 5;
      active_hole_idx = -1;
      playSfx(1400, 20);
      globalTimer = millis() + random(400, 1000);
    }
    // Check for Fall
    else if (millis() > hole_active_timer) {
      active_hole_idx = -1;
      lives--;
      playSfx(80, 500);
      if (lives <= 0) currentState = GAMEOVER;
      globalTimer = millis() + 1000;
    }
  }
}

void manhole_draw() {
  int xs[]={25, 103, 25, 103}, ys[]={20, 20, 50, 50};
  for(int i=0; i<4; i++) {
    u8g2.drawCircle(xs[i], ys[i], 8);
    if(active_hole_idx == i) safeDisc(xs[i], ys[i], 5); // The person falling
  }
  // Player's Arm/Cover
  safeLine(64, 32, pX, pY);
}

// ==========================================================
// GAME 6: HELMET
// ==========================================================
int toolY[3]; int toolX[3];
void helmet_reset() { score = 0; lives = 3; pX = 10; for(int i=0; i<3; i++) { toolX[i] = 30 + i*35; toolY[i] = -random(10, 100); } }
void helmet_update() {
  pX = constrain(pX + vx * 4.0f, 5, 125);
  for(int i=0; i<3; i++) {
    toolY[i] += 2; if (toolY[i] > 64) toolY[i] = -random(10, 64);
    if (abs(pX - toolX[i]) < 8 && abs(toolY[i] - 55) < 6) { lives--; pX = 10; playSfx(100, 400); if(lives <= 0) currentState = GAMEOVER; }
  }
  if (pX > 118) { score += 10; pX = 10; playSfx(1500, 30); }
}
void helmet_draw() {
  for(int i=0; i<3; i++) { safeLine(toolX[i]-2, toolY[i]-2, toolX[i]+2, toolY[i]+2); safeLine(toolX[i]+2, toolY[i]-2, toolX[i]-2, toolY[i]+2); }
  u8g2.drawFrame(120, 45, 8, 15); safeDisc((int)pX, 55, 4);
}

// ==========================================================
// SYSTEM CORE
// ==========================================================
void setup() { pinMode(BTN_A, INPUT_PULLUP); pinMode(BTN_MENU, INPUT_PULLUP); u8g2.begin(); }
void loop() {
  rawX = analogRead(STICK_X); rawY = analogRead(STICK_Y);
  if (abs(rawX-512) > 80) vx = (rawX-512)/512.0f; else vx = 0;
  if (abs(rawY-512) > 80) vy = (rawY-512)/512.0f; else vy = 0;

  u8g2.firstPage();
  do {
    switch (currentState) {
      case MENU:
        u8g2.setFont(u8g2_font_6x12_tf); u8g2.drawStr(10, 12, "NONTENDO");
        u8g2.setFont(u8g2_font_6x12_tf); u8g2.drawStr(10, 18, "GAME NO WATCH");
        u8g2.setFont(u8g2_font_5x7_tf);
        u8g2.drawStr(20, 24, menuSelection == 0 ? "> 1. OCTOPUS" : "  1. OCTOPUS");
        u8g2.drawStr(20, 31, menuSelection == 1 ? "> 2. CHEF" : "  2. CHEF");
        u8g2.drawStr(20, 38, menuSelection == 2 ? "> 4. VERMIN" : "  4. VERMIN");
        u8g2.drawStr(20, 45, menuSelection == 3 ? "> 5. MANHOLE" : "  5. MANHOLE");
        u8g2.drawStr(20, 52, menuSelection == 4 ? "> 6. HELMET" : "  6. HELMET");
        break;
      case OCTOPUS: octo_draw(); break;
      case CHEF: chef_draw(); break;
      case VERMIN: vermin_draw(); break;
      case MANHOLE: manhole_draw(); break;
      case HELMET: helmet_draw(); break;
      case GAMEOVER: u8g2.setFont(u8g2_font_7x14_tf); u8g2.drawStr(30, 30, "GAME OVER"); u8g2.setCursor(45, 45); u8g2.print("SC: "); u8g2.print(score); break;
    }
    if (currentState != MENU && currentState != GAMEOVER) {
      u8g2.setFont(u8g2_font_4x6_tf); u8g2.setCursor(2, 62); u8g2.print("SCORE:"); u8g2.print(score); u8g2.setCursor(100, 62); u8g2.print("L:"); u8g2.print(lives);
    }
  } while (u8g2.nextPage());

  static unsigned long lastIn = 0;
  if (millis() - lastIn > 180) {
    if (currentState == MENU) {
      if (vy > 0.4) menuSelection = min(4, menuSelection + 1);
      else if (vy < -0.4) menuSelection = max(0, menuSelection - 1);
      if (digitalRead(BTN_A) == LOW) {
        if (menuSelection == 0) { currentState = OCTOPUS; octo_reset(); }
        else if (menuSelection == 1) { currentState = CHEF; chef_reset(); }
        else if (menuSelection == 2) { currentState = VERMIN; vermin_reset(); }
        else if (menuSelection == 3) { currentState = MANHOLE; manhole_reset(); }
        else if (menuSelection == 4) { currentState = HELMET; helmet_reset(); }
        playSfx(900, 50); lastIn = millis();
      }
    } else if (currentState == GAMEOVER && digitalRead(BTN_A) == LOW) { currentState = MENU; lastIn = millis(); }
    else if (digitalRead(BTN_MENU) == LOW) { currentState = MENU; lastIn = millis(); }
  }
  if (currentState == OCTOPUS) octo_update();
  else if (currentState == CHEF) chef_update();
  else if (currentState == VERMIN) vermin_update();
  else if (currentState == MANHOLE) manhole_update();
  else if (currentState == HELMET) helmet_update();
}