#include <Arduino.h>
#include <U8g2lib.h>
#include <Wire.h>

// Using Page Buffer mode (1) to save RAM on Uno/Nano
U8G2_SH1106_128X64_NONAME_1_HW_I2C u8g2(U8G2_R0, /* reset=*/ U8X8_PIN_NONE);

#define PIN_FIRE   10 
#define STICK_X    A0
#define STICK_Y    A1
#define BZ_SFX     3  

// --- GAME STATES ---
enum GameState { STATE_TITLE, STATE_PLAYING, STATE_GAMEOVER };
GameState currentState = STATE_TITLE;

// --- PLAYER STATE ---
float px, py;
int hp, score;
bool tripleShot;
unsigned long lastFire = 0;
float difficulty = 1.0;

// --- ENTITY STRUCTS ---
struct EnemyEntity { float x, y, startY; int type; bool active; };
struct BulletEntity { float x, y, vy; bool active; };
struct PowerEntity { float x, y; bool active; };
struct Particle { float x, y, vx, vy; int life; bool active; };

// --- POOLS ---
BulletEntity bullets[12];
EnemyEntity enemies[6];
Particle particles[15];
PowerEntity powerup = {0, 0, false};

// --- STARFIELD ---
struct Star { float x, y; float speed; };
Star stars[10];

void resetGame() {
  px = 20; py = 32;
  hp = 5; score = 0;
  difficulty = 1.0;
  tripleShot = false;
  powerup.active = false;
  for (int i = 0; i < 12; i++) bullets[i].active = false;
  for (int i = 0; i < 6; i++) enemies[i].active = false;
  for (int i = 0; i < 15; i++) particles[i].active = false;
  currentState = STATE_PLAYING;
}

void spawnExplosion(float x, float y) {
  for (int i = 0; i < 15; i++) {
    if (!particles[i].active) {
      particles[i] = {x, y, (float)random(-20, 21)/10.0f, (float)random(-20, 21)/10.0f, random(5, 15), true};
    }
  }
}

void spawnBullet(float x, float y, float vy) {
  for (int i = 0; i < 12; i++) {
    if (!bullets[i].active) {
      bullets[i] = {x, y, vy, true};
      return;
    }
  }
}

void setup() {
  pinMode(PIN_FIRE, INPUT_PULLUP);
  u8g2.begin();
  randomSeed(analogRead(A2));
  
  // Initialize stars with different speeds for parallax effect
  for(int i=0; i<10; i++) {
    stars[i] = {(float)random(0, 128), (float)random(0, 64), (float)random(5, 20) / 10.0f};
  }
}

void updateGame() {
  difficulty = 1.0 + (score / 1000.0); // Game gets faster as score increases

  // 1. PLAYER MOVEMENT
  int ax = analogRead(STICK_X);
  int ay = analogRead(STICK_Y);
  if (ax < 400) px -= 2.2; if (ax > 624) px += 2.2;
  if (ay < 400) py -= 2.2; if (ay > 624) py += 2.2;
  px = constrain(px, 5, 120); py = constrain(py, 5, 55);

  // 2. PLAYER SHOOTING
  if (digitalRead(PIN_FIRE) == LOW && millis() - lastFire > 180) {
    spawnBullet(px + 8, py, 0);
    if (tripleShot) {
      spawnBullet(px + 8, py - 2, -0.8);
      spawnBullet(px + 8, py + 2, 0.8);
      tone(BZ_SFX, 1200, 15);
    } else {
      tone(BZ_SFX, 1000, 10);
    }
    lastFire = millis();
  }

  // 3. UPDATE PARTICLES
  for (int i = 0; i < 15; i++) {
    if (particles[i].active) {
      particles[i].x += particles[i].vx;
      particles[i].y += particles[i].vy;
      particles[i].life--;
      if (particles[i].life <= 0) particles[i].active = false;
    }
  }

  // 4. UPDATE BULLETS
  for (int i = 0; i < 12; i++) {
    if (bullets[i].active) {
      bullets[i].x += 4.5;
      bullets[i].y += bullets[i].vy;
      if (bullets[i].x > 128 || bullets[i].y < 0 || bullets[i].y > 64) bullets[i].active = false;
    }
  }

  // 5. UPDATE ENEMIES
  for (int i = 0; i < 6; i++) {
    if (!enemies[i].active && random(0, 50) < (int)(2 * difficulty)) {
      float startY = random(10, 50);
      enemies[i] = {130, startY, startY, random(0, 2), true};
    }
    
    if (enemies[i].active) {
      if (enemies[i].type == 0) enemies[i].x -= (1.5 * difficulty);
      else {
        enemies[i].x -= (1.2 * difficulty);
        enemies[i].y = enemies[i].startY + sin(millis() / 200.0 + i) * 15.0;
      }

      // Hit by bullet
      for (int j = 0; j < 12; j++) {
        if (bullets[j].active && abs(bullets[j].x - enemies[i].x) < 7 && abs(bullets[j].y - enemies[i].y) < 7) {
          enemies[i].active = false; bullets[j].active = false;
          score += 20; 
          spawnExplosion(enemies[i].x, enemies[i].y);
          tone(BZ_SFX, 400 + random(0, 200), 20);
          if (!powerup.active && random(0, 10) == 0) powerup = {enemies[i].x, enemies[i].y, true};
        }
      }
      // Hit player
      if (abs(enemies[i].x - px) < 7 && abs(enemies[i].y - py) < 7) {
          enemies[i].active = false; hp--; 
          spawnExplosion(px, py);
          tone(BZ_SFX, 100, 150); tripleShot = false;
          if (hp <= 0) currentState = STATE_GAMEOVER;
      }
      if (enemies[i].x < -10) enemies[i].active = false;
    }
  }

  // 6. POWERUP
  if (powerup.active) {
    powerup.x -= 1.2;
    if (abs(powerup.x - px) < 8 && abs(powerup.y - py) < 8) {
      powerup.active = false; tripleShot = true; score += 50;
      tone(BZ_SFX, 1500, 40); delay(10); tone(BZ_SFX, 2000, 40);
    }
    if (powerup.x < -10) powerup.active = false;
  }
}

// --- DRAWING ---
void drawPlayer(int x, int y) {
  u8g2.drawTriangle(x-4, y-3, x+7, y, x-4, y+3);
  u8g2.drawBox(x-5, y-1, 3, 3); // Engine
  if (tripleShot) { u8g2.drawFrame(x-6, y-5, 3, 11); }
}

void drawEnemy(EnemyEntity& e) {
  if (e.type == 0) { // Tie-Style
    u8g2.drawVLine(e.x-3, e.y-4, 9); u8g2.drawVLine(e.x+3, e.y-4, 9);
    u8g2.drawBox(e.x-1, e.y-1, 3, 3);
  } else { // Interceptor-Style
    u8g2.drawTriangle(e.x-4, e.y, e.x+4, e.y-4, e.x+4, e.y+4);
    u8g2.drawPixel(e.x-5, e.y);
  }
}

void drawGame() {
  u8g2.firstPage();
  do {
    // Parallax Starfield
    for(int i=0; i<10; i++) {
      if (currentState == STATE_PLAYING) {
        stars[i].x -= stars[i].speed;
        if(stars[i].x < 0) { stars[i].x = 128; stars[i].y = random(0, 64); }
      }
      u8g2.drawPixel((int)stars[i].x, (int)stars[i].y);
    }

    if (currentState == STATE_TITLE) {
      u8g2.setFont(u8g2_font_logisoso16_tr);
      u8g2.drawStr(10, 30, "STELLAR");
      u8g2.drawStr(45, 52, "CRASH");
      u8g2.setFont(u8g2_font_6x10_tf);
      if ((millis() / 500) % 2 == 0) u8g2.drawStr(25, 62, "PRESS FIRE TO START");
    } 
    else if (currentState == STATE_PLAYING || currentState == STATE_GAMEOVER) {
      drawPlayer((int)px, (int)py);
      for (int i = 0; i < 12; i++) if (bullets[i].active) u8g2.drawHLine((int)bullets[i].x, (int)bullets[i].y, 3);
      for (int i = 0; i < 6; i++) if (enemies[i].active) drawEnemy(enemies[i]);
      for (int i = 0; i < 15; i++) if (particles[i].active) u8g2.drawPixel((int)particles[i].x, (int)particles[i].y);
      
      if (powerup.active) {
        u8g2.drawFrame((int)powerup.x-3, (int)powerup.y-4, 8, 9);
        u8g2.setFont(u8g2_font_u8glib_4_tf); u8g2.drawStr((int)powerup.x-1, (int)powerup.y+2, "P");
      }

      // UI
      u8g2.setFont(u8g2_font_u8glib_4_tf);
      u8g2.setCursor(2, 63); u8g2.print("HP: "); 
      for(int i=0; i<hp; i++) u8g2.drawBox(15 + (i*4), 59, 2, 4);
      u8g2.setCursor(90, 63); u8g2.print(score);

      if (currentState == STATE_GAMEOVER) {
        u8g2.drawBox(20, 20, 88, 24);
        u8g2.setDrawColor(0);
        u8g2.setFont(u8g2_font_7x14_tf);
        u8g2.drawStr(32, 36, "GAME OVER");
        u8g2.setDrawColor(1);
      }
    }
  } while ( u8g2.nextPage() );
}

void loop() {
  if (currentState == STATE_TITLE) {
    if (digitalRead(PIN_FIRE) == LOW) resetGame();
  } else if (currentState == STATE_PLAYING) {
    updateGame();
  } else if (currentState == STATE_GAMEOVER) {
    if (digitalRead(PIN_FIRE) == LOW) currentState = STATE_TITLE;
  }
  drawGame();
}
