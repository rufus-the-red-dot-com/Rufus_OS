/*
 * PROJECT: CORTEX-DIGI v4.7 (Integrated HUD Mini-games)
 * HARDWARE: Arduino Nano + 1.3" SH1106 OLED
 * ---------------------------------------------------
 * PIN MAPPING:
 * OLED: SDA -> A4, SCL -> A5 (SH1106 I2C)
 * AUDIO: BZ_MEL -> 3, BZ_BASS -> 6
 * JOYSTICK: SW -> 2 (ZOOM), Y -> A1, X -> A0
 * BUTTONS: HIT: 10, STAND: 9 (THEME), MUTE: 11, SAVE/EXIT: 5
 * C-LINK: POINT 1 -> 4, POINT 2 -> 7
 */

#include <Arduino.h>
#include <U8g2lib.h>
#include <Wire.h>
#include <EEPROM.h>

U8G2_SH1106_128X64_NONAME_1_HW_I2C u8g2(U8G2_R0, /* reset=*/ U8X8_PIN_NONE);

// --- HARDWARE DEFS ---
#define BZ_MEL      3   
#define BZ_BASS     6   
#define PIN_HIT     10  
#define PIN_STAND   9   
#define PIN_MUTE    11  
#define PIN_SAVE    5   
#define STICK_SW    2   
#define STICK_Y     A1
#define COMM_A      4   
#define COMM_B      7   

// --- VERIFIED USER SPRITES (16x15) ---
static const unsigned char egg_0[] U8X8_PROGMEM = { 0xe0,0x01,0x30,0x02,0x38,0x07,0x1c,0x0f,0x04,0x0f,0x12,0x1e,0x32,0x1c,0x32,0x10,0x72,0x10,0x72,0x10,0x62,0x16,0x0c,0x0f,0x18,0x07,0xf0,0x03,0x00,0x00 };
static const unsigned char egg_1[] U8X8_PROGMEM = { 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xe0,0x07,0x18,0x18,0x1c,0x38,0x0e,0x78,0x06,0x70,0x33,0x80,0xf1,0x80,0xe3,0xb0,0x06,0x78,0xfc,0x3f,0x00,0x00 };
static const unsigned char botamon_0[] U8X8_PROGMEM = { 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x10,0x08,0x10,0xf4,0x1f,0xfc,0x37,0xfc,0x3f,0xfe,0x7f,0x00,0x00,0x00,0x00 };
static const unsigned char botamon_1[] U8X8_PROGMEM = { 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x04,0x20,0x04,0xf0,0x0f,0xd0,0x0b,0xf0,0x0f,0x70,0x0e,0xfe,0x7f,0x00,0x00,0x00,0x00 };
static const unsigned char koromon_0[] U8X8_PROGMEM = { 0x1c,0x38,0xec,0x37,0x0c,0x30,0x02,0x40,0x11,0x88,0x11,0x88,0x11,0x88,0x81,0x81,0x81,0x81,0x01,0x80,0x01,0x80,0xfe,0x7f,0x00,0x00,0x00,0x00,0x00,0x00 };
static const unsigned char koromon_1[] U8X8_PROGMEM = { 0x60,0x06,0x50,0x0a,0x88,0x11,0x24,0x24,0x24,0x24,0x24,0x24,0x14,0x28,0xf4,0x2f,0xe4,0x27,0xe4,0x27,0xc4,0x23,0x08,0x10,0xf0,0x0f,0x00,0x00,0x00,0x00 };
static const unsigned char augumon_0[] U8X8_PROGMEM = { 0xe0,0x03,0x10,0x04,0xd8,0x08,0x86,0x09,0xc1,0x11,0x0f,0x10,0x02,0x10,0x7c,0x08,0x18,0x0a,0x14,0x11,0x1c,0x17,0x30,0x24,0xcc,0x23,0x4a,0x55,0x7e,0x7f };
static const unsigned char augumon_1[] U8X8_PROGMEM = { 0x00,0x00,0xe0,0x03,0x10,0x04,0xd8,0x08,0x86,0x09,0xc1,0x11,0x0f,0x10,0x02,0x10,0x7c,0x08,0x18,0x0a,0x14,0x11,0x14,0x15,0x2c,0x22,0xca,0x55,0x7e,0x7f };

static const unsigned char poop_0[] U8X8_PROGMEM = { 0x40,0x22,0x49,0x1a,0x2c,0x5e,0x7e,0x00 };
static const unsigned char poop_1[] U8X8_PROGMEM = { 0x41,0x82,0x49,0x18,0x2c,0x5e,0x7e,0x00 };

// --- LOGIC DEFS ---
enum Species { EGG, BOTAMON, KOROMON, AGUMON };
enum Screen { TITLE, IDLE, MENU, TRAINING, STATUS, BATTLE, COMM, RESULT };

struct DigiCore {
  Species type = EGG; 
  Screen mode = TITLE;
  int hunger = 2;
  int strength = 0;
  int poop = 0;
  int weight = 1;
  int wins = 0;
  int menuIdx = 0;
  int mashCount = 0;
  int opponentPower = 0;
  bool isZoomed = false;
  bool isLightMode = false;
  
  // Movement & Physics
  float posX = 56.0;
  float posY_offset = 0; 
  float velY = 0;        
  int moveDir = 1;
  
  String commStatus = "WAITING...";
  String resultMsg = "";
  unsigned long lastTick;
  unsigned long birth;
  unsigned long lastMove;
  unsigned long actionTime;
} vpet;

void playChirp(int freq, int dur) {
  tone(BZ_MEL, freq, dur);
  digitalWrite(BZ_BASS, HIGH);
  delay(dur/2);
  digitalWrite(BZ_BASS, LOW);
}

// Advanced Rendering Engine
void drawAdvancedSprite(int x, int y, int w, int h, const unsigned char* bitmap, bool mirror, int tilt, int scale) {
    for (int i = 0; i < h; i++) {
        for (int j = 0; j < w; j++) {
            if (pgm_read_byte(bitmap + (i * ((w + 7) / 8)) + (j / 8)) & (1 << (j % 8))) {
                int drawX = mirror ? (x + (w - 1 - j) * scale) : (x + j * scale);
                int drawY = y + i * scale;
                if (tilt != 0) {
                    int offset = (h - i) / (h / 3);
                    drawX += (tilt * offset);
                }
                if (scale > 1) u8g2.drawBox(drawX, drawY, scale, scale);
                else u8g2.drawPixel(drawX, drawY);
            }
        }
    }
}

// --- COMM LINK ---
bool attemptPulse(int dataPin, int groundPin) {
    pinMode(groundPin, OUTPUT); digitalWrite(groundPin, LOW); 
    pinMode(dataPin, OUTPUT); digitalWrite(dataPin, LOW); 
    delay(50); digitalWrite(dataPin, HIGH);
    pinMode(dataPin, INPUT_PULLUP);
    unsigned long start = millis();
    while(digitalRead(dataPin) == HIGH && (millis() - start < 300));
    return (digitalRead(dataPin) == LOW);
}

void runCommBattle() {
    vpet.commStatus = "SCANNING...";
    int activeData = -1;
    if (attemptPulse(COMM_A, COMM_B)) activeData = COMM_A;
    else if (attemptPulse(COMM_B, COMM_A)) activeData = COMM_B;

    if (activeData != -1) {
        vpet.commStatus = "EXCHANGING...";
        int myPower = vpet.strength * 10 + random(0, 15);
        pinMode(activeData, OUTPUT); digitalWrite(activeData, LOW); delay(myPower); digitalWrite(activeData, HIGH);
        pinMode(activeData, INPUT_PULLUP);
        unsigned long duration = pulseIn(activeData, LOW, 1000000); 
        if (duration > 0 && myPower > (int)duration) { vpet.commStatus = "VICTORY!"; vpet.wins++; playChirp(2000, 500); }
        else vpet.commStatus = "DEFEAT...";
    } else vpet.commStatus = "LINK ERROR";
    
    pinMode(COMM_A, INPUT_PULLUP); pinMode(COMM_B, INPUT_PULLUP);
    delay(2000); vpet.mode = IDLE;
}

void setup() {
  pinMode(BZ_MEL, OUTPUT); pinMode(BZ_BASS, OUTPUT);
  pinMode(PIN_HIT, INPUT_PULLUP); pinMode(PIN_STAND, INPUT_PULLUP);
  pinMode(PIN_MUTE, INPUT_PULLUP); pinMode(PIN_SAVE, INPUT_PULLUP);
  pinMode(STICK_SW, INPUT_PULLUP);
  u8g2.begin();
  randomSeed(analogRead(A0) + micros());
  vpet.birth = millis(); vpet.lastTick = millis();
}

void handleInput() {
  unsigned long now = millis();
  if (digitalRead(PIN_SAVE) == LOW) {
    if (vpet.mode != IDLE && vpet.mode != TITLE) {
      vpet.mode = IDLE; playChirp(300, 100); delay(300); return;
    }
  }
  
  if (vpet.mode == IDLE) {
    if (digitalRead(STICK_SW) == LOW) { vpet.isZoomed = !vpet.isZoomed; playChirp(800, 50); delay(300); }
    if (digitalRead(PIN_STAND) == LOW) { vpet.isLightMode = !vpet.isLightMode; playChirp(1500, 50); delay(300); }
  }

  if (vpet.mode == TITLE) {
    if (digitalRead(STICK_SW) == LOW || digitalRead(PIN_HIT) == LOW) { vpet.mode = IDLE; playChirp(880, 100); delay(300); }
    return;
  }
  
  int yVal = analogRead(STICK_Y);
  if (vpet.mode == MENU) {
    if (yVal < 300) { vpet.menuIdx = max(0, vpet.menuIdx - 1); delay(150); } 
    if (yVal > 700) { vpet.menuIdx = min(3, vpet.menuIdx + 1); delay(150); } 
  }
  
  if (digitalRead(PIN_HIT) == LOW) {
    if (vpet.mode == IDLE) { vpet.mode = MENU; }
    else if (vpet.mode == MENU) {
      if (vpet.type == EGG && vpet.menuIdx < 3) playChirp(150, 200);
      else {
         if (vpet.menuIdx == 0) { vpet.hunger = min(4, vpet.hunger + 1); vpet.weight += 1; playChirp(1500, 50); vpet.mode = IDLE; }
         else if (vpet.menuIdx == 1) { vpet.mode = TRAINING; vpet.mashCount = 0; vpet.actionTime = now; }
         else if (vpet.menuIdx == 2) { vpet.mode = BATTLE; vpet.mashCount = 0; vpet.opponentPower = random(20, 45); vpet.actionTime = now; }
         else if (vpet.menuIdx == 3) { vpet.mode = COMM; }
      }
    }
    delay(200);
  }
  
  if (digitalRead(PIN_STAND) == LOW && (vpet.mode == TRAINING || vpet.mode == BATTLE)) {
      vpet.mashCount++; playChirp(440, 15); delay(30);
  }
  if (digitalRead(PIN_MUTE) == LOW && vpet.poop > 0) { vpet.poop--; playChirp(600, 100); delay(250); }
  if (digitalRead(PIN_SAVE) == LOW && vpet.mode == IDLE) { vpet.mode = STATUS; delay(250); }
}

void loop() {
  handleInput();
  unsigned long now = millis();
  
  if (now - vpet.lastTick > 60000) { 
    if (vpet.hunger > 0) vpet.hunger--;
    if (vpet.type != EGG && random(10) > 7) vpet.poop = min(4, vpet.poop + 1);
    vpet.lastTick = now;
  }
  
  // EVOLUTION
  if (vpet.type == EGG && (now - vpet.birth > 60000)) { vpet.type = BOTAMON; vpet.posX = 56; playChirp(1000, 500); }
  else if (vpet.type == BOTAMON && (now - vpet.birth > 600000)) { vpet.type = KOROMON; playChirp(440, 500); }
  else if (vpet.type == KOROMON && (now - vpet.birth > 1200000) && vpet.wins > 0) { vpet.type = AGUMON; playChirp(1200, 800); }

  // PHYSICS LOOP (Shared across Idle, Training, and Battle)
  if (vpet.mode == IDLE || vpet.mode == TRAINING || vpet.mode == BATTLE || vpet.mode == RESULT) {
    vpet.posY_offset += vpet.velY;
    if (vpet.posY_offset < 0) vpet.velY += 0.4; 
    else { vpet.posY_offset = 0; vpet.velY = 0; if (random(500) == 0) vpet.velY = -3.5; }

    // Character stops walking during actions but still waddles
    if (vpet.type != EGG && vpet.mode == IDLE) {
      if (now - vpet.lastMove > 100) { 
        vpet.posX += (vpet.moveDir * 1.5); 
        if (vpet.posX > 100 || vpet.posX < 10) vpet.moveDir *= -1; 
        vpet.lastMove = now;
      }
    } else { vpet.posX = 56; }
  }

  // Mini-game Resolution
  if (vpet.mode == TRAINING && (now - vpet.actionTime > 5000)) {
    if (vpet.mashCount >= 20) { vpet.strength = min(4, vpet.strength + 1); vpet.resultMsg = "SUCCESS!"; playChirp(2000, 300); }
    else { vpet.resultMsg = "FAILED..."; playChirp(200, 400); }
    vpet.mode = RESULT; vpet.actionTime = now;
  }
  if (vpet.mode == BATTLE && (now - vpet.actionTime > 5000)) {
    if (vpet.mashCount > vpet.opponentPower) { vpet.wins++; vpet.resultMsg = "WINNER!"; playChirp(2000, 400); }
    else { vpet.resultMsg = "LOSER..."; playChirp(200, 500); }
    vpet.mode = RESULT; vpet.actionTime = now;
  }
  if (vpet.mode == RESULT && (now - vpet.actionTime > 2000)) vpet.mode = IDLE;

  u8g2.firstPage();
  do {
    if (vpet.isLightMode) { u8g2.setDrawColor(1); u8g2.drawBox(0, 0, 128, 64); u8g2.setDrawColor(0); }
    else u8g2.setDrawColor(1);

    u8g2.setFont(u8g2_font_6x10_tf);
    if (vpet.mode == TITLE) { u8g2.drawStr(25, 30, "CORTEX-DIGI"); u8g2.drawStr(30, 50, "PRESS START"); } 
    else if (vpet.mode == IDLE || vpet.mode == TRAINING || vpet.mode == BATTLE || vpet.mode == RESULT) {
      // 1. Draw HUD
      u8g2.drawStr(0, 10, "H:"); for(int i=0; i<vpet.hunger; i++) u8g2.drawDisc(15+(i*6), 7, 2);
      u8g2.drawStr(60, 10, "S:"); for(int i=0; i<vpet.strength; i++) u8g2.drawDisc(75+(i*6), 7, 2);
      
      // 2. Draw Sprite
      int scale = vpet.isZoomed ? 2 : 1;
      int py = (vpet.isZoomed ? 20 : 32) + (int)vpet.posY_offset; 
      int px = vpet.isZoomed ? (int)vpet.posX - 8 : (int)vpet.posX;
      int currentAnimFrame = (now / 400) % 2; 

      if (vpet.type == EGG) {
        int shakeX = (now % 800 < 400) ? -1 : 1;
        drawAdvancedSprite(px + shakeX, py, 16, 15, currentAnimFrame ? egg_1 : egg_0, false, 0, scale);
      } else {
        const unsigned char* f0; const unsigned char* f1;
        if(vpet.type == BOTAMON) { f0 = botamon_0; f1 = botamon_1; }
        else if(vpet.type == KOROMON) { f0 = koromon_0; f1 = koromon_1; }
        else { f0 = augumon_0; f1 = augumon_1; }
        
        int tilt = (currentAnimFrame == 0) ? -1 : 1;
        bool mirror = (vpet.moveDir == -1);
        drawAdvancedSprite(px, py, 16, 15, currentAnimFrame ? f1 : f0, mirror, tilt, scale);
      }

      // 3. Draw Waste
      for(int i=0; i<vpet.poop; i++) u8g2.drawXBMP(100+(i*9), 45, 8, 8, currentAnimFrame ? poop_1 : poop_0);

      // 4. Draw Overlay for Mini-games
      if (vpet.mode == TRAINING || vpet.mode == BATTLE) {
        u8g2.drawRBox(15, 48, 98, 14, 2); u8g2.setDrawColor(vpet.isLightMode ? 1 : 0);
        u8g2.drawFrame(17, 50, 94, 10);
        int fill = min(92, vpet.mashCount * 2);
        u8g2.drawBox(18, 51, fill, 8);
        u8g2.setDrawColor(vpet.isLightMode ? 0 : 1);
        u8g2.setFont(u8g2_font_u8glib_4_tf); u8g2.drawStr(20, 46, vpet.mode == BATTLE ? "BATTLE! MASH B" : "TRAINING! MASH B");
      }
      else if (vpet.mode == RESULT) {
        u8g2.drawRBox(25, 25, 78, 20, 3); u8g2.setDrawColor(vpet.isLightMode ? 1 : 0);
        u8g2.drawStr(32, 38, vpet.resultMsg.c_str());
        u8g2.setDrawColor(vpet.isLightMode ? 0 : 1);
      }
    }
    else if (vpet.mode == MENU) {
      u8g2.drawRFrame(5, 5, 118, 54, 4);
      u8g2.setCursor(15, 15); u8g2.print(vpet.menuIdx == 0 ? "> FEED " : "  FEED ");
      u8g2.setCursor(15, 25); u8g2.print(vpet.menuIdx == 1 ? "> TRAIN " : "  TRAIN ");
      u8g2.setCursor(15, 35); u8g2.print(vpet.menuIdx == 2 ? "> BATTLE " : "  BATTLE ");
      u8g2.setCursor(15, 45); u8g2.print(vpet.menuIdx == 3 ? "> C-LINK " : "  C-LINK ");
    }
    else if (vpet.mode == COMM) {
      u8g2.drawStr(25, 25, "CORTEX-LINK");
      u8g2.setCursor(25, 40); u8g2.print(vpet.commStatus);
      u8g2.drawStr(25, 55, "PRESS B TO START");
    }
    else if (vpet.mode == STATUS) {
      u8g2.setCursor(20, 22); u8g2.print("AGE: "); u8g2.print((now-vpet.birth)/60000); u8g2.print("m");
      u8g2.setCursor(20, 34); u8g2.print("WGT: "); u8g2.print(vpet.weight); u8g2.print("g");
      u8g2.setCursor(20, 46); u8g2.print("WINS: "); u8g2.print(vpet.wins);
    }
  } while (u8g2.nextPage());
}