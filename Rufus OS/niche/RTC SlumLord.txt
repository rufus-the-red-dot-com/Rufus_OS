/*
 * PROJECT: BARON: STREETS TO SUITES v21.0
 * HARDWARE: Arduino Nano + SH1106 OLED + DS3231 RTC
 * INPUT: 3-Button/Probe Layout (D11:A, D10:B, D9:C)
 * ---------------------------------------------------
 * UPDATED: EXIT STREETS via 3-second hold on B.
 * UPDATED: Input Lock prevents auto-selecting menu items after exit.
 * UPDATED: Persistent Market History and Trend Arrows.
 * STREETS: Multi-item Drug Wars trading (Weed, Acid, Speed).
 * ESTATE: Real-time rent and condition management.
 * JAIL: 12-hour sentences + Match-3/Columns training.
 */

#include <Arduino.h>
#include <U8g2lib.h>
#include <Wire.h>
#include <RTClib.h>
#include <EEPROM.h>

U8G2_SH1106_128X64_NONAME_1_HW_I2C u8g2(U8G2_R0, /* reset=*/ U8X8_PIN_NONE);
RTC_DS3231 rtc;

// --- PINOUT ---
#define PIN_A 11  // Left / Buy
#define PIN_B 10  // Action / Cycle Product / HOLD FOR EXIT
#define PIN_C 9   // Right / Sell
#define BZ 3

// --- DATA STRUCTURES ---
struct Property {
  bool active;
  long buyPrice;
  int condition;
  bool occupied;
  long rentBase;
};

struct Offer {
  byte type;       // 1: Text, 2: Call
  long amount;
  uint32_t expiresTS;
  uint32_t payoutTS; 
  bool active;
  bool pendingPayout;
};

struct PlayerSave {
  uint32_t magic;
  long cash;
  long debt;
  uint32_t jailReleaseTS;
  uint32_t lastTS;
  int stash[3];     // 0:Weed, 1:Acid, 2:Speed
  int heat;         
  int skillLaw;     // Match-3 Bonus
  int skillTrade;   // Columns Bonus
  Property units[2];
  Offer currentOffer;
  long prices[3];    
  long oldPrices[3]; 
} save;

enum Mode { HUB, BANK, STREETS, ESTATE, JAIL, PHONE, J_MATCH3, J_COLUMNS, NOTIFY };
Mode mode = HUB;

// Simulation Globals
int menuIdx = 0, subIdx = 0, jailMenuIdx = 0;
const char* statusStr = "";
DateTime now;
unsigned long rtcTick = 0;

// Button/Hold Globals
bool bA, bB, bC;
bool bB_locked = false; // Prevents auto-select after long press
unsigned long holdTimer = 0;

// Mini-game Globals
uint8_t grid[20];
int curX = 0, curY = 0, selIdx = -1;
int colX = 1;
unsigned long gameTick = 0;

// --- UTILS ---
void playTone(int f, int d) { tone(BZ, f, d); delay(d/1.2); }
void saveGame() { EEPROM.put(0, save); }

void shufflePrices() {
  for(int i=0; i<3; i++) save.oldPrices[i] = save.prices[i];
  randomSeed(now.minute() + now.hour() + now.day());
  save.prices[0] = random(20, 100);   
  save.prices[1] = random(150, 500);  
  save.prices[2] = random(800, 2500); 
  saveGame();
}

void resetGame() {
  save.magic = 0xBA21; // Version 21 Magic
  save.cash = 0; save.debt = 0;
  for(int i=0; i<3; i++) {
      save.stash[i] = 0;
      save.prices[i] = 0;
      save.oldPrices[i] = 0;
  }
  save.heat = 0; save.skillLaw = 0; save.skillTrade = 0;
  save.jailReleaseTS = 0;
  save.currentOffer.active = false;
  save.currentOffer.pendingPayout = false;
  for(int i=0; i<2; i++) save.units[i].active = false;
  
  now = rtc.now();
  shufflePrices();
  saveGame();
  
  playTone(200, 500);
  mode = HUB;
}

void loadGame() {
  EEPROM.get(0, save);
  if (save.magic != 0xBA21) { 
    resetGame();
  }
}

// --- REAL-TIME ENGINE ---

void processTime() {
  uint32_t unix = now.unixtime();
  if (save.lastTS == 0) { save.lastTS = unix; return; }
  uint32_t diff = unix - save.lastTS;
  
  if (diff > 300) shufflePrices(); 
  if (diff < 60) return;

  for(int i=0; i<2; i++) {
    if(save.units[i].active && save.units[i].occupied) {
      uint32_t days = diff / 86400;
      if (days > 0) {
        save.cash += (save.units[i].rentBase + (save.skillLaw * 150)) * days;
        save.units[i].condition = max(0, save.units[i].condition - (int)days);
        if(save.units[i].condition < 5) save.units[i].occupied = false;
      }
    }
  }

  if (save.debt > 0) {
    uint32_t days = diff / 86400;
    if (days > 0) save.debt += (save.debt * 0.03) * days;
  }

  if (save.currentOffer.pendingPayout && unix > save.currentOffer.payoutTS) {
      save.cash += (save.currentOffer.amount * 1.35);
      save.currentOffer.pendingPayout = false;
      statusStr = "LOAN REPAID (+35%)";
      mode = NOTIFY;
  }

  if (!save.currentOffer.active && !save.currentOffer.pendingPayout && random(100) < 5) {
    save.currentOffer.active = true;
    save.currentOffer.type = 1; 
    save.currentOffer.amount = random(1000, 6000);
    save.currentOffer.expiresTS = unix + random(86400, 3024000); 
  }
  
  if (save.currentOffer.active && unix > save.currentOffer.expiresTS) save.currentOffer.active = false;
  save.lastTS = unix;
}

void triggerCall() {
  if (mode != JAIL && !save.currentOffer.active && !save.currentOffer.pendingPayout && random(4000) < 2) {
    save.currentOffer.active = true;
    save.currentOffer.type = 2; 
    save.currentOffer.amount = random(500, 2000);
    save.currentOffer.expiresTS = now.unixtime() + 15;
  }
}

// --- INPUT HANDLER ---

void handleInput() {
  bA = (digitalRead(PIN_A) == LOW);
  bool bB_phys = (digitalRead(PIN_B) == LOW);
  bC = (digitalRead(PIN_C) == LOW);

  // LOCK LOGIC: If probe is high (released), clear the lock
  if (!bB_phys) bB_locked = false;
  
  // Assign virtual bB state only if not locked
  bB = (bB_phys && !bB_locked);

  if (!bA && !bB_phys && !bC && holdTimer == 0) return;

  if (mode == HUB) {
    if (bA) { menuIdx = (menuIdx == 0) ? 4 : menuIdx - 1; playTone(400, 20); delay(200); }
    if (bC) { menuIdx = (menuIdx + 1) % 5; playTone(400, 20); delay(200); }
    if (bB) {
      if (menuIdx == 0) { mode = STREETS; subIdx = 0; }
      if (menuIdx == 1) { mode = ESTATE; subIdx = 0; }
      if (menuIdx == 2) mode = PHONE;
      if (menuIdx == 3) mode = BANK;
      if (menuIdx == 4) resetGame();
      playTone(800, 40); delay(200);
    }
  }
  else if (mode == STREETS) {
    // 3-SECOND HOLD ON B FOR EXIT (Probe Optimized)
    if (bB_phys) { // Use physical check for the timer
      if (holdTimer == 0) { 
        holdTimer = millis(); 
        subIdx = (subIdx + 1) % 3; // Immediate cycle on touch
        playTone(600, 20);
      }
      if (millis() - holdTimer > 3000) {
        // EXIT TRIGGERED
        if (random(100) < (save.heat)) { 
          save.jailReleaseTS = now.unixtime() + 43200; 
          mode = JAIL; playTone(100, 600);
        } else { mode = HUB; if(save.heat > 0) save.heat -= 2; }
        holdTimer = 0; 
        bB_locked = true; // LOCK INPUT until probe is lifted
        saveGame(); delay(200);
      }
    } else { holdTimer = 0; }

    if (bA) { // BUY
      long price = max(10L, save.prices[subIdx] - (save.skillTrade * 20));
      if (save.cash >= price) { 
          save.cash -= price; save.stash[subIdx]++; save.heat += 2; 
          playTone(900, 20); 
      } else { playTone(150, 100); }
      delay(200);
    }
    else if (bC) { // SELL
      if (save.stash[subIdx] > 0) {
          save.cash += save.prices[subIdx]; save.stash[subIdx]--;
          playTone(1300, 20);
      } else { playTone(150, 100); }
      delay(200);
    }
  }
  else if (mode == BANK) {
    if (bB) {
      if (save.debt == 0) {
        save.debt = 2500; save.cash += 2500; 
        playTone(1200, 100); mode = HUB; bB_locked = true; saveGame();
      }
    }
    if (bA) { mode = HUB; delay(200); }
  }
  else if (mode == ESTATE) {
    if (bC) { subIdx = (subIdx + 1) % 2; playTone(500, 20); delay(200); }
    if (bB) {
        if (!save.units[subIdx].active && save.cash >= 7000) {
            save.cash -= 7000;
            save.units[subIdx].active = true;
            save.units[subIdx].condition = 100;
            save.units[subIdx].occupied = true;
            save.units[subIdx].rentBase = 800;
            saveGame(); playTone(1500, 100);
        } else if (save.units[subIdx].active && save.units[subIdx].condition < 100) {
            for(int i=0; i<20; i++) grid[i] = random(1,5);
            curX=0; curY=0; selIdx=-1; mode = J_MATCH3;
        }
        delay(200);
    }
    if (bA) { mode = HUB; delay(200); }
  }
  else if (mode == PHONE) {
    if (bB && save.currentOffer.active) {
       if (save.cash >= save.currentOffer.amount) {
         save.cash -= save.currentOffer.amount;
         save.currentOffer.active = false;
         save.currentOffer.pendingPayout = true;
         save.currentOffer.payoutTS = now.unixtime() + 604800; 
         statusStr = "CONTRACT ISSUED"; mode = NOTIFY; bB_locked = true;
       }
       delay(200);
    }
    if (bA) { mode = HUB; delay(200); }
  }
  else if (mode == JAIL) {
    if (bA || bC) { jailMenuIdx = !jailMenuIdx; playTone(300, 20); delay(200); }
    if (bB) { 
        if(jailMenuIdx == 0) { for(int i=0; i<20; i++) grid[i]=random(1,5); curX=0; curY=0; selIdx=-1; mode=J_MATCH3; }
        else { mode=J_COLUMNS; colX=1; gameTick=millis(); }
        delay(200);
    }
    if (now.unixtime() >= save.jailReleaseTS) { mode = HUB; save.heat = 0; bB_locked = true; saveGame(); }
  }
  else if (mode == J_MATCH3) {
    if (bA) { curX = (curX > 0) ? curX - 1 : 3; delay(150); }
    if (bC) { curX = (curX < 3) ? curX + 1 : 0; delay(150); }
    if (bB) {
      int idx = curY * 4 + curX;
      if (selIdx == -1) { selIdx = idx; playTone(600, 20); }
      else {
        uint8_t t = grid[selIdx]; grid[selIdx] = grid[idx]; grid[idx] = t;
        if (grid[idx] == grid[selIdx]) { 
           save.skillLaw++; save.jailReleaseTS -= 3600; 
           mode = JAIL; playTone(1800, 50); 
        }
        selIdx = -1;
      }
      delay(200);
    }
  }
  else if (mode == J_COLUMNS) {
    if (bA) { colX = max(0, colX - 1); delay(150); }
    if (bC) { colX = min(3, colX + 1); delay(150); }
    if (bB) { 
      save.skillTrade++; save.jailReleaseTS -= 900; 
      mode = JAIL; playTone(1400, 50);
      delay(200);
    }
  }
  else if (mode == NOTIFY) {
    if (bB) { mode = HUB; bB_locked = true; delay(200); }
  }
}

void setup() {
  Wire.begin(); u8g2.begin(); rtc.begin();
  pinMode(PIN_A, INPUT_PULLUP); pinMode(PIN_B, INPUT_PULLUP); pinMode(PIN_C, INPUT_PULLUP);
  loadGame();
  now = rtc.now();
  if (now.unixtime() < save.jailReleaseTS) mode = JAIL;
}

void loop() {
  if (millis() - rtcTick > 2000) {
    now = rtc.now();
    processTime();
    if (mode != JAIL) triggerCall();
    rtcTick = millis();
  }

  handleInput();

  if (save.currentOffer.active && save.currentOffer.type == 2) {
    if (now.unixtime() > save.currentOffer.expiresTS) save.currentOffer.active = false;
    else if (millis() % 1000 < 400) tone(BZ, 1800, 40);
  }

  u8g2.firstPage();
  do {
    u8g2.setFont(u8g2_font_u8glib_4_tf);
    
    // HEADER: Date | Cash | Heat | Clock
    u8g2.setCursor(0, 6); u8g2.print(now.month()); u8g2.print("/"); u8g2.print(now.day()); u8g2.print("/"); u8g2.print(now.year()%100);
    u8g2.setCursor(42, 6); u8g2.print(F("$")); u8g2.print(save.cash);
    u8g2.setCursor(80, 6); u8g2.print(F("HT:")); u8g2.print(save.heat);
    u8g2.setCursor(105, 6); u8g2.print(now.hour()); u8g2.print(now.second()%2?":":" "); u8g2.print(now.minute());
    u8g2.drawHLine(0, 8, 128);

    switch(mode) {
      case HUB:
        u8g2.setCursor(10, 25); u8g2.print(F("SYNDICATE-OS v21.0"));
        { const char* m[] = {"STREET TRADING", "REAL ESTATE", "COMMS UNIT", "CENTRAL BANK", "SYSTEM RESET"};
          for(int i=0; i<5; i++) {
            u8g2.setCursor(20, 38+(i*6));
            u8g2.print(menuIdx == i ? F("> ") : F("  ")); u8g2.print(m[i]);
          }
        }
        if(save.currentOffer.active) { u8g2.setCursor(90, 25); u8g2.print(F("(!) CALL")); }
        break;

      case STREETS:
        u8g2.setCursor(5, 18); u8g2.print(F("-- BLACK MARKET --"));
        { const char* items[] = {"WEED", "ACID", "SPEED"};
          u8g2.setCursor(10, 30); u8g2.print(F("ITEM: ")); u8g2.print(items[subIdx]);
          u8g2.setCursor(10, 40); u8g2.print(F("PRICE: $")); u8g2.print(save.prices[subIdx]);
          if(save.oldPrices[subIdx] > 0) {
              if (save.prices[subIdx] > save.oldPrices[subIdx]) u8g2.print(F(" ^"));
              else if (save.prices[subIdx] < save.oldPrices[subIdx]) u8g2.print(F(" v"));
              else u8g2.print(F(" -"));
              u8g2.setCursor(10, 50); u8g2.print(F("WAS: $")); u8g2.print(save.oldPrices[subIdx]);
          }
          u8g2.setCursor(80, 50); u8g2.print(F("STASH:")); u8g2.print(save.stash[subIdx]);
        }
        u8g2.setCursor(10, 63); u8g2.print(F("A:BY C:SL B:CYC HLD B:EXT"));
        break;

      case ESTATE:
        u8g2.setCursor(5, 18); u8g2.print(F("-- ESTATE MGR --"));
        u8g2.setCursor(10, 30); u8g2.print(F("UNIT: #0")); u8g2.print(subIdx+1);
        if (save.units[subIdx].active) {
            u8g2.setCursor(10, 40); u8g2.print(F("COND: ")); u8g2.print(save.units[subIdx].condition); u8g2.print(F("%"));
            u8g2.setCursor(10, 50); u8g2.print(F("RENT: $")); u8g2.print(save.units[subIdx].rentBase + (save.skillLaw * 150));
            u8g2.setCursor(10, 62); u8g2.print(F("B: ACTION  C:NEXT"));
        } else {
            u8g2.setCursor(10, 40); u8g2.print(F("PRICE: $7000"));
            u8g2.setCursor(10, 62); u8g2.print(F("B: PURCHASE  C:NEXT"));
        }
        break;

      case BANK:
        u8g2.setCursor(10, 20); u8g2.print(F("-- THE BANK --"));
        if (save.debt > 0) { u8g2.setCursor(10, 35); u8g2.print(F("OWED: $")); u8g2.print(save.debt); }
        else { u8g2.setCursor(10, 35); u8g2.print(F("CREDIT: $2500")); u8g2.setCursor(10, 50); u8g2.print(F("B: TAKE LOAN")); }
        u8g2.setCursor(10, 62); u8g2.print(F("A: BACK"));
        break;

      case JAIL:
        u8g2.setCursor(35, 20); u8g2.print(F("FEDERAL CELL"));
        { uint32_t rem = (save.jailReleaseTS > now.unixtime()) ? (save.jailReleaseTS - now.unixtime()) : 0;
          u8g2.setCursor(15, 30); u8g2.print(F("TIME LEFT: ")); u8g2.print(rem/3600); u8g2.print(F("H"));
        }
        u8g2.setCursor(15, 48); u8g2.print(jailMenuIdx == 0 ? F("> STUDY LAW") : F("  STUDY LAW"));
        u8g2.setCursor(15, 58); u8g2.print(jailMenuIdx == 1 ? F("> TRADE SKILL") : F("  TRADE SKILL"));
        break;

      case J_MATCH3:
        u8g2.setCursor(5, 18); u8g2.print(F("SYNCING DATA..."));
        for(int i=0; i<20; i++) {
          int x = (i % 4) * 20 + 30, y = (i / 4) * 10 + 25;
          u8g2.drawFrame(x, y, 12, 8);
          if (selIdx == i) u8g2.drawBox(x+2, y+2, 8, 4);
          else { u8g2.setCursor(x+4, y+7); u8g2.print(grid[i]); }
        }
        u8g2.drawFrame(30 + (curX * 20) - 2, 25 + (curY * 10) - 2, 16, 12);
        break;

      case PHONE:
        u8g2.setCursor(10, 20); u8g2.print(F("-- COMMS --"));
        if (save.currentOffer.active) {
          u8g2.setCursor(10, 35); u8g2.print(save.currentOffer.type == 2 ? F("CALL: $") : F("MSG: $")); 
          u8g2.print(save.currentOffer.amount);
          u8g2.setCursor(10, 62); u8g2.print(F("B:SIGN  A:BACK"));
        } else if (save.currentOffer.pendingPayout) {
            u8g2.setCursor(10, 35); u8g2.print(F("LOAN ACTIVE..."));
            u8g2.setCursor(10, 45); u8g2.print(F("WAITING REPAY."));
            u8g2.setCursor(10, 62); u8g2.print(F("A: BACK"));
        } else { u8g2.setCursor(10, 35); u8g2.print(F("NO INCOMING.")); u8g2.setCursor(10, 62); u8g2.print(F("A: BACK")); }
        break;

      case NOTIFY:
        u8g2.drawRBox(10, 20, 108, 35, 2); u8g2.setDrawColor(0);
        u8g2.setCursor(15, 35); u8g2.print(statusStr);
        u8g2.setCursor(15, 48); u8g2.print(F("B: DISMISS")); u8g2.setDrawColor(1);
        break;
    }
  } while (u8g2.nextPage());
}